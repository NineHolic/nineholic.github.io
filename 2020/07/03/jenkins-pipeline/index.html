<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Jenkins pipeline 的使用 &mdash; Nine</title><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/css/components/collection.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/css/globals/common.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/css/posts/index.css"><link rel="stylesheet" href="https://blog.nine.gt.tc/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/posts/base16.solarized.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css"/><link rel="canonical" href="https://blog.nine.gt.tc/2020/07/03/jenkins-pipeline/"><link rel="alternate" type="application/atom+xml" title="Nine" href="https://blog.nine.gt.tc/feed.xml"><link rel="shortcut icon" href="https://blog.nine.gt.tc/favicon.ico"><meta property="og:title" content="Jenkins pipeline 的使用"><meta name="keywords" content="Jenkins, Pipeline, Groovy"><meta name="og:keywords" content="Jenkins, Pipeline, Groovy"><meta name="description" content="学习和使用 Jenkins pipeline 过程中遇到的问题和解决办法"><meta name="og:description" content="学习和使用 Jenkins pipeline 过程中遇到的问题和解决办法"><meta property="og:url" content="https://blog.nine.gt.tc/2020/07/03/jenkins-pipeline/"><meta property="og:site_name" content="Nine"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2020-07-03"> <script src="https://blog.nine.gt.tc/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://blog.nine.gt.tc/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-5QHWNF9C4N"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-5QHWNF9C4N'); </script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?291b6bd8af9846f6fab5b11aa98b7415"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1> <a href="https://blog.nine.gt.tc/" title="Nine" class="title-info"> <img src="https://blog.nine.gt.tc/assets/images/avatar.jpeg" class="avatar-top avatar-user avatar avatar-small">Nine </a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://blog.nine.gt.tc/" class="site-header-nav-item" target="" title="首页">首页</a> <a href="https://blog.nine.gt.tc/categories/" class="site-header-nav-item" target="" title="分类">分类</a> <a href="https://blog.nine.gt.tc/archives/" class="mobile-hidden site-header-nav-item" target="" title="归档">归档</a> <a href="https://blog.nine.gt.tc/links/" class="mobile-hidden site-header-nav-item" target="" title="链接">链接</a> <a href="https://blog.nine.gt.tc/about/" class="site-header-nav-item" target="" title="关于">关于</a> <a class="mobile-hidden" href="https://blog.nine.gt.tc/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Jenkins pipelin"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Jenkins pipeline 的使用</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2020/07/03 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://blog.nine.gt.tc/categories/#Jenkins" title="Jenkins">Jenkins</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 4938 字，约 15 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>学习和使用 Jenkins pipeline 过程中遇到的问题和解决办法</p><h5 id="shell-脚本进程被杀问题">shell 脚本进程被杀问题</h5><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20200702112856063.png" alt="image-20200702112856063" /></p><blockquote><p>自 1.260 版本开始，Jenkins 默认会在构建完成后杀死构建过程中由 jenkins 中的 shell 命令触发的衍生进程ProcessTreeKiller: https://wiki.jenkins.io/display/JENKINS/ProcessTreeKiller](https://wiki.jenkins.io/display/JENKINS/ProcessTreeKiller)</p></blockquote><p><strong>方法一</strong></p><p>修改配置，启动 jenkins 时禁止其杀死衍生进程：<code class="language-plaintext highlighter-rouge">vim /etc/sysconfig/jenkins</code></p><p>在 JENKINS_JAVA_OPTIONS 中加入 <code class="language-plaintext highlighter-rouge">-Dhudson.util.ProcessTree.disable=true</code></p><p>重启 jenkins 生效：<code class="language-plaintext highlighter-rouge">systemctl restart jenkins</code> <img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20200703171005773.png" alt="image-20200703171005773" /></p><p><strong>方法二：</strong></p><p><strong>Pipeline：</strong>设置 JENKINS_NODE_COOKIE 参数的值：</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">withEnv</span><span class="o">([</span><span class="s1">'JENKINS_NODE_COOKIE=dontkillme'</span><span class="o">])</span> <span class="o">{</span>
    <span class="n">sh</span> <span class="s1">'sh ${tomcatHome}/bin/startup.sh'</span>
   <span class="o">}</span>
</code></pre></div></div><p><strong>非 Pipeline：</strong></p><ul><li><p>在执行 shell 输入框中加入<code class="language-plaintext highlighter-rouge">BUILD_ID=dontKillMe</code> ，即可防止 jenkins 杀死启动的进程</p></li><li><p>临时改变 BUILD_ID 值，使得 jenkins 不会找到并结束掉 run.sh 启动的后台进程</p></li></ul><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">OLD_BUILD_ID</span><span class="o">=</span><span class="nv">$BUILD_ID</span>
<span class="nb">echo</span> <span class="nv">$OLD_BUILD_ID</span>
<span class="nb">export </span><span class="nv">BUILD_ID</span><span class="o">=</span>dontKillMe
<span class="c"># 执行 tomcat 启动脚本</span>
sh <span class="k">${</span><span class="nv">tomcat</span><span class="k">}</span>/bin/startup.sh
<span class="c"># 改回原来的 BUILD_ID 值</span>
<span class="nb">export </span><span class="nv">BUILD_ID</span><span class="o">=</span><span class="nv">$OLD_BUILD_ID</span>
<span class="nb">echo</span> <span class="nv">$BUILD_ID</span>
</code></pre></div></div><h5 id="node未找到命令">node：未找到命令</h5><p>使用 sonar 扫描项目时报警告：</p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20200706170135922.png" alt="image-20200706170135922" /></p><p>发现服务器上未装NodeJS，但是装好后 Jenkins 内执行 shell 命令无法获取环境变量</p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20200706165959947.png" alt="image-20200706165959947" /></p><p>于是搜索一番后找到原因：https://blog.csdn.net/zzusimon/article/details/57080337</p><p>（1） 可以通过<code class="language-plaintext highlighter-rouge">-i</code>参数和<code class="language-plaintext highlighter-rouge">-l</code>参数让 bash 为 login shell and interactive shell，就可以读取<code class="language-plaintext highlighter-rouge">/etc/profile</code>和<code class="language-plaintext highlighter-rouge">~/.bash_profile</code>等文件，即在 jenkins Execute Shell 里可以这么写</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash -ilex</span>
...

...
</code></pre></div></div><p>对于 e 参数表示一旦出错，就退出当前的 shell，x 参数表示可以显示所执行的每一条命令</p><p>（2）使用流水线语法生成脚本，将需要调用 NodeJS 的 shell 命令写在括号内：</p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20200706171200545.png" alt="image-20200706170928237" /></p><p>测试成功：</p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20200706170928237.png" alt="image-20200706171200545" /></p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20200706171317860.png" alt="image-20200706171317860" /></p><h5 id="构建超时自动停止">构建超时自动停止</h5><p>在 pipeline 设置超时时间，超过该限制时会中断 pipeline 的执行</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 方式一：在 pipeline 中配置</span>
<span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">options</span><span class="o">{</span>
        <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span><span class="mi">15</span><span class="o">,</span> <span class="nl">unit:</span><span class="s1">'SECONDS'</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="n">stages</span> <span class="o">{</span> <span class="o">..</span> <span class="o">}</span>
  <span class="c1">// ..</span>
<span class="o">}</span>


<span class="c1">// 方式二：在 stage 中配置</span>
<span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Run'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">retry</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">'./deploy.sh'</span>
                <span class="o">}</span>
 
                <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">3</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">'MINUTES'</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">'./ren_test.sh'</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div><p>maven 类型项目在构建环境下配置，勾选 Abort the build if it’s stuck</p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20240116143326726.png" alt="image-20240116143326726" /></p><h5 id="在-pipeline-中触发其他-job">在 pipeline 中触发其他 job</h5><p>在项目构建前需要先构建项目 test-common，可以在 pipeline 进行配置</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 放在 stages 下，变量用双引号</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'ltprivate-center-common'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">30</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">'SECONDS'</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">script</span><span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">"正在构建 test-common, 分支：${params.branch}"</span>
                        <span class="n">build</span> <span class="n">job</span> <span class="o">:</span><span class="s1">'test-common'</span><span class="o">,</span> <span class="nl">parameters:</span><span class="o">[</span><span class="n">string</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">'branch'</span><span class="o">,</span> <span class="nl">value:</span> <span class="s2">"${params.branch}"</span><span class="o">)]</span>
                        <span class="n">echo</span> <span class="s2">"完成构建"</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div><h5 id="when-指令的使用">when 指令的使用</h5><p><code class="language-plaintext highlighter-rouge">when</code> 指令位于stage指令中，允许 pipeline 根据给定的条件决定是否应该执行阶段，必须包含至少一个条件</p><p>例：<code class="language-plaintext highlighter-rouge">buildType</code>为<code class="language-plaintext highlighter-rouge">Choice Parameter</code>参数，当选择 deploy 进行构建时，只会执行满足条件的 stage</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'更新'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span> <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">'buildType'</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">'deploy'</span> <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"更新完成"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'回滚'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span> <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">'buildType'</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">'rollback'</span> <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"回滚更新完成"</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>控制台输出</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started by user admin
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins in /data/.jenkins/workspace/测试目录/webhook-common
[Pipeline] {
[Pipeline] stage
[Pipeline] { (更新)
Stage "更新" skipped due to when conditional
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (回滚)
[Pipeline] echo
回滚更新完成
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
</code></pre></div></div><blockquote><p>其它使用条件</p><p><strong>changelog</strong>: <code class="language-plaintext highlighter-rouge">when { changelog '.*^\\[DEPENDENCY\\] .+$' }</code>，构建的SCM变更日志包含一个给定的正则表达式模式，则执行该阶段</p><p><strong>anyOf</strong>：<code class="language-plaintext highlighter-rouge">when { anyOf { branch 'master'; branch 'staging' } }</code>，当至少有一个嵌套条件为 <code class="language-plaintext highlighter-rouge">true</code> 时执行，必须包含至少一个条件</p><p>https://blog.csdn.net/a772304419/article/details/132456478</p></blockquote><h5 id="input-指令的使用">input 指令的使用</h5><p>input 允许用户在执行各个 stage 时由人工确认是否继续进行，官网 input 语法：https://www.jenkins.io/doc/book/pipeline/syntax/#input，input 书写方式有以下两种</p><ul><li>message 呈现给用户的提示信息</li><li>id 可选，默认为stage名称</li><li>ok 默认表单上的 ok 文本</li><li>submitter 可选，以逗号分隔的用户列表或允许提交的外部组名。默认允许任何用户</li><li>submitterParameter 环境变量的可选名称。如果存在，用submitter 名称设置</li><li>parameters 提示提交者提供的一个可选的参数列表</li></ul><p><strong>方式一</strong></p><p>input 与 steps 同级</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'更新'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span> <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">'buildType'</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">'deploy'</span> <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"更新完成"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'回滚'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span> 
                <span class="n">beforeInput</span> <span class="kc">false</span>
                <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">'buildType'</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">'rollback'</span> 
            <span class="o">}</span>
            <span class="n">input</span> <span class="o">{</span>
                <span class="n">message</span> <span class="s2">"是否继续回退更新？"</span>
                <span class="n">ok</span> <span class="s2">"继续"</span>
                <span class="n">parameters</span> <span class="o">{</span>
                    <span class="n">string</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">'history_number'</span><span class="o">,</span> <span class="nl">defaultValue:</span> <span class="s1">'lastVersion'</span><span class="o">,</span> <span class="nl">description:</span> <span class="s1">'请输入回退更新的历史构建编号，回退到上个版本使用：lastVersion'</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="s2">"history_number: ${env.history_number}，回滚完成"</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><blockquote><p>PS：当 when 和 input 同时使用时需要在 when 内增加<code class="language-plaintext highlighter-rouge">beforeInput true</code>，此时<code class="language-plaintext highlighter-rouge">when</code> 条件将首先计算，只有当条件计算为 true 时才会进入<code class="language-plaintext highlighter-rouge">input</code>，默认情况下 beforeInput 为 false</p><p>以上述流水线为例，beforeInput 为 false，input 会在 when 之前执行，因此选择 deploy 构建时，流水会卡在 input 处</p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20240129103102950.png" alt="image-20240129103102950" /></p></blockquote><p><strong>方式二</strong></p><p>input 在 steps 内部</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'更新'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span> <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">'buildType'</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">'deploy'</span> <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"更新完成"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'回滚'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span> <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">'buildType'</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">'rollback'</span> <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">5</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">'SECONDS'</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">def</span> <span class="n">inputResult</span> <span class="o">=</span> <span class="n">input</span> <span class="nl">message:</span> <span class="s2">"是否继续回退更新？"</span><span class="o">,</span> <span class="nl">ok:</span> <span class="s2">"继续"</span><span class="o">,</span> <span class="nl">parameters:</span> <span class="o">[</span>
                            <span class="n">string</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">'history_number'</span><span class="o">,</span> <span class="nl">defaultValue:</span> <span class="s1">'lastVersion'</span><span class="o">,</span> <span class="nl">description:</span> <span class="s1">'请输入回退更新的历史构建编号，回退到上个版本使用：lastVersion'</span><span class="o">)</span>
                        <span class="o">]</span>
                    <span class="o">}</span>
                    <span class="n">echo</span> <span class="s2">"history_number: ${inputResult}，回滚完成"</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h5 id="构建失败时通知">构建失败时通知</h5><p>使用企业微信机器人通知，官网 post 语法：https://www.jenkins.io/doc/book/pipeline/syntax/#post</p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20240116144228521.png" alt="image-20240116144228521" /></p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>    
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'检出'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span><span class="o">{</span>
                    <span class="c1">// 将当前构建结果设置为失败</span>
                    <span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="s2">"FAILURE"</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
	<span class="n">post</span><span class="o">{</span>
        <span class="c1">// success{}</span>
        <span class="c1">// 构建失败时发送通知</span>
        <span class="n">failure</span><span class="o">{</span>
            <span class="n">sh</span> <span class="s1">'''curl -s -H "Content-Type: application/json" -X POST -d \'{
				"msgtype": "markdown",
				"markdown": {
				 "content": "&lt;font color=\\"warning\\"&gt;**Jenkins任务通知**&lt;/font&gt; \\n
				 &gt;构建编号：&lt;font color=\\"comment\\"&gt;\'"${BUILD_DISPLAY_NAME}"\'&lt;/font&gt;
				 &gt;任务名称：&lt;font color=\\"comment\\"&gt;\'"${JOB_BASE_NAME}"\'&lt;/font&gt;
				 &gt;构建分支：&lt;font color=\\"comment\\"&gt;\'"${branch}"\'&lt;/font&gt;
				 &gt;构建状态：&lt;font color=\\"comment\\"&gt;Failure&lt;/font&gt;"
				}
			}\' \'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx\'''</span><span class="err">'</span>
        <span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h5 id="generic-webhook-trigger-配置">Generic Webhook Trigger 配置</h5><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20240109151457785.png" alt="image-20240109151457785" /></p><p>过滤条件：仅当 test-admin目录下的文件被 push 时，触发构建，若需立即触发构建需勾上<code class="language-plaintext highlighter-rouge">Override Quiet Period</code></p><p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/jenkins/image-20240109151555424.png" alt="image-20240109151555424" /></p><p>webhook 触发 url 为：http://192.168.216.131/jenkins/generic-webhook-trigger/invoke?token=abcd&amp;jobQuietPeriod=0</p><div style="font-size: 16px;border-left: 3px solid #3498db;background-color:#f0f8ff;padding: 16px 0px 1px 1px;border-radius: 3px;"><ul><li>本文作者：<a href="https://blog.nine.gt.tc" target="_blank">Nine</a></li><li>本文链接：<a href="https://blog.nine.gt.tc/2020/07/03/jenkins-pipeline/" target="_blank">https://blog.nine.gt.tc/2020/07/03/jenkins-pipeline/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://giscus.app/client.js" data-repo="NineHolic/blog-comments" data-repo-id="MDEwOlJlcG9zaXRvcnkzNjU4ODk4MzQ=" data-category="Announcements" data-category-id="DIC_kwDOFc8JKs4CwE7i" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://blog.nine.gt.tc/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://blog.nine.gt.tc/assets/search_data.json?v=1763618948', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://blog.nine.gt.tc/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © <script>document.write(new Date().getFullYear())</script> <span title="Nine">Nine</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/NineHolic/nineholic.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden" style="margin-bottom: 7px;"><li> <a href="https://blog.nine.gt.tc/" title="首页" target="">首页</a></li><li> <a href="https://blog.nine.gt.tc/categories/" title="分类" target="">分类</a></li><li> <a href="https://blog.nine.gt.tc/archives/" title="归档" target="">归档</a></li><li> <a href="https://blog.nine.gt.tc/links/" title="链接" target="">链接</a></li><li> <a href="https://blog.nine.gt.tc/about/" title="关于" target="">关于</a></li><li><a href="https://blog.nine.gt.tc/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><span id="runtime_span"> <script type="text/javascript"> function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("05/10/2021 16:20:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "本站已运行 " + A + " 天 " + B + " 小时 " + C + " 分 " + D + " 秒" } show_runtime(); </script> </span></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://blog.nine.gt.tc/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script> <script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script> <script> $(document).ready(function() { $("p img").each(function() { var strA = "<a href='" + this.src + "' itemscope=\"\" itemtype=\"http://schema.org/ImageObject\" itemprop=\"url\" data-fancybox=\"default\" rel=\"default\"></a>"; $(this).wrapAll(strA); }); }); </script></body></html>
