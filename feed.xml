<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="https://blog.nine.gt.tc/feed.xml" rel="self" type="application/atom+xml" /><link href="https://blog.nine.gt.tc/" rel="alternate" type="text/html" /><updated>2025-11-17T11:52:46+08:00</updated><id>https://blog.nine.gt.tc/feed.xml</id><title type="html">Nine</title><subtitle>blog</subtitle><author><name>Nine</name></author><entry><title type="html">Confluence 的安装与使用</title><link href="https://blog.nine.gt.tc/2024/04/19/linux-install-confluence/" rel="alternate" type="text/html" title="Confluence 的安装与使用" /><published>2024-04-19T00:00:00+08:00</published><updated>2024-04-19T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2024/04/19/linux-install-confluence</id><content type="html" xml:base="https://blog.nine.gt.tc/2024/04/19/linux-install-confluence/"><![CDATA[<p>Confluence 是由 Atlassian 公司推出的一款企业级团队协作与知识管理工具。它是一个团队协作空间，将知识与协作无缝融合，让团队能够在一个平台上创建、协作和组织所有工作。</p>

<h5 id="1安装部署">1、安装部署</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 临时修改为 permissive，同时 selinux 配置改为 disabled，下次重启服务器后会生效</span>
setenforce 0
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config

<span class="c"># 新建安装目录</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /data/confluence/wiki/data <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>777 /data/confluence/wiki/data

<span class="c"># 保证当前目录下存在 docker-compose.yml，根据配置启动服务</span>
docker compose up <span class="nt">-d</span>

<span class="c"># 查看日志</span>
docker logs <span class="nt">--tail</span> 300 <span class="nt">-f</span> confluence

<span class="c"># 访问服务：http://192.168.216.131:18090</span>
点击 Next -&gt; License key 页面记录下 Server ID
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker-compose.yml</code>内容如下：</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code>services:
  mysql8-confluence:
    image: mysql:8.0
    container_name: mysql8-confluence
    ports:
      - 3308:3306
    volumes:
      - /data/confluence/wiki/mysql/conf.d:/etc/mysql/conf.d
      - /data/confluence/wiki/mysql/data:/var/lib/mysql
    security_opt: 
      - seccomp:unconfined
    environment:
      TZ: Asia/Shanghai
      MYSQL_ROOT_PASSWORD: 'root1234!'
    command: --default-authentication-plugin=mysql_native_password --lower-case-table-names=1

  confluence:
    image: atlassian/confluence:7.9.0
    container_name: confluence
    environment:
      TZ: Asia/Shanghai
    ports:
      - 18090:8090
    volumes:
      - /data/confluence/wiki/data:/var/atlassian/confluence
</code></pre></div></div>

<h5 id="2环境配置">2、环境配置</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 进入 mysql 容器中</span>
docker <span class="nb">exec</span> <span class="nt">-it</span> mysql8-confluence bash

<span class="c"># 登录 mysql</span>
mysql <span class="nt">-uroot</span> <span class="nt">-p</span>

<span class="c"># 创建数据库</span>
CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin<span class="p">;</span>
quit
<span class="nb">exit</span>

<span class="c"># 网页下载插件</span>
https://flynine.lanzoul.com/iziJq3b9sumj

<span class="c"># 复制插件到容器 confluence 中</span>
docker <span class="nb">cp </span>atlassian-agent.jar confluence:/home/

<span class="c"># 修改环境变量脚本，增加一行配置</span>
docker <span class="nb">cp </span>confluence:/opt/atlassian/confluence/bin/setenv.sh <span class="nb">.</span>
vim setenv.sh

<span class="nv">CATALINA_OPTS</span><span class="o">=</span><span class="s2">"-javaagent:/home/atlassian-agent.jar </span><span class="k">${</span><span class="nv">CATALINA_OPTS</span><span class="k">}</span><span class="s2">"</span>

docker <span class="nb">cp </span>setenv.sh confluence:/opt/atlassian/confluence/bin/

<span class="c"># 下载 mysql 驱动</span>
wget https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-j-9.5.0.tar.gz

<span class="c"># 解压，复制 jar 包到容器中</span>
<span class="nb">tar</span> <span class="nt">-zxvf</span> mysql-connector-j-9.5.0.tar.gz
docker <span class="nb">cp </span>mysql-connector-j-9.5.0/mysql-connector-j-9.5.0.jar confluence:/opt/atlassian/confluence/confluence/WEB-INF/lib

<span class="c"># 重启容器</span>
docker restart confluence

<span class="c"># 有打印 agent working 则说明插件加载成功</span>
docker logs <span class="nt">--tail</span> 100 <span class="nt">-f</span> confluence

<span class="c"># 重启容器</span>
docker restart confluence

<span class="c"># 有打印 agent working 则说明破解插件加载成功</span>
docker logs <span class="nt">--tail</span> 300 <span class="nt">-f</span> confluence

<span class="c"># 根据上面记录的 Server ID 来生成授权码</span>
docker <span class="nb">exec</span> <span class="nt">-it</span> confluence bash <span class="nt">-c</span> <span class="s2">"java -jar /home/atlassian-agent.jar -p conf -m test.com -m test -o http://192.168.216.131:18090 -s BRJ3-T8L7-J5M3-UIZH"</span>

<span class="c"># 刷新网页：http://192.168.216.131:18090</span>
填入上面生成的 license code —&gt; 选择 My own database -&gt; 选择 MySQL，Setup <span class="nb">type </span>选择 By connection string：jdbc:mysql://192.168.216.131:3308/confluence?useUnicode<span class="o">=</span><span class="nb">true</span>&amp;zeroDateTimeBehavior<span class="o">=</span>convertToNull&amp;characterEncoding<span class="o">=</span>UTF-8&amp;useSSL<span class="o">=</span><span class="nb">false</span>&amp;sessionVariables<span class="o">=</span><span class="nv">transaction_isolation</span><span class="o">=</span><span class="s1">'READ-COMMITTED'</span>
用户名 root，密码在 docker-compose.yml 中有写明，填写后 Test connection，成功后 Next，等待设置完成 -&gt; 选择 empty site -&gt; 设置账号
</code></pre></div></div>

<p><strong>参考</strong></p>

<ul>
  <li><a href="https://zhile.io/2018/12/20/atlassian-license-crack.html">Atlassian系列产品及插件激活方法 JIRA8.19.0+</a></li>
</ul>]]></content><author><name>Nine</name></author><category term="Confluence" /><summary type="html"><![CDATA[Confluence 的安装与使用]]></summary></entry><entry><title type="html">Termux 的简单使用</title><link href="https://blog.nine.gt.tc/2024/03/12/termux-with-android/" rel="alternate" type="text/html" title="Termux 的简单使用" /><published>2024-03-12T00:00:00+08:00</published><updated>2024-03-12T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2024/03/12/termux-with-android</id><content type="html" xml:base="https://blog.nine.gt.tc/2024/03/12/termux-with-android/"><![CDATA[<p>Termux 是一个 Android 下一个高级的终端模拟器，开源且不需要 root，支持 apt 管理软件包，十分方便安装软件包，完美支持 Python、 PHP、 Ruby、 Nodejs、 MySQL 等。</p>

<p>首次启动 Termux 时需要从<a href="http://termux.net/bootstrap/">远程服务器</a>加载数据，可能会遇到以下报错，可尝试使用代理或流量再重试：</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/android/image-20240312102411238.png" alt="image-20240312102411238" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 替换官方源为 TUNA 镜像源</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s@^\(deb.*stable main\)$@#\1\ndeb https://mirrors.tuna.tsinghua.edu.cn/termux/apt/termux-main stable main@'</span> <span class="nv">$PREFIX</span>/etc/apt/sources.list
apt update <span class="o">&amp;&amp;</span> apt upgrade

<span class="c"># 安装基本工具</span>
pkg <span class="nb">install </span>vim curl wget git unzip <span class="nt">-y</span>
</code></pre></div></div>

<p>Termux 除了支持 <code class="language-plaintext highlighter-rouge">apt</code> 命令外，还在此基础上封装了 <code class="language-plaintext highlighter-rouge">pkg</code> 命令，<code class="language-plaintext highlighter-rouge">pkg</code> 命令向下兼容 <code class="language-plaintext highlighter-rouge">apt</code> 命令</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pkg search &lt;query&gt;              <span class="c"># 搜索包</span>
pkg <span class="nb">install</span> &lt;package&gt;           <span class="c"># 安装包</span>
pkg uninstall &lt;package&gt;         <span class="c"># 卸载包</span>
pkg reinstall &lt;package&gt;         <span class="c"># 重新安装包</span>
pkg update                      <span class="c"># 更新源</span>
pkg upgrade                     <span class="c"># 升级软件包</span>
pkg list-all                    <span class="c"># 列出可供安装的所有包</span>
pkg list-installed              <span class="c"># 列出已经安装的包</span>
pkg show &lt;package&gt;              <span class="c"># 显示某个包的详细信息</span>
pkg files &lt;package&gt;             <span class="c"># 显示某个包的相关文件夹路径</span>

<span class="c"># 相关目录</span>
<span class="nb">echo</span> <span class="nv">$HOME</span>
/data/data/com.termux/files/home

<span class="nb">echo</span> <span class="nv">$PREFIX</span>
/data/data/com.termux/files/usr

<span class="nb">echo</span> <span class="nv">$TMPPREFIX</span>
/data/data/com.termux/files/usr/tmp/zsh
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 终端配色，github 访问不了的可以使用第二个地址</span>
sh <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://github.com/Cabbagec/termux-ohmyzsh/raw/master/install.sh<span class="si">)</span><span class="s2">"</span>
sh <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://html.sqlsec.com/termux-install.sh<span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>

<p>Android6.0 以上会弹框确认是否授权访问文件，点击<code class="language-plaintext highlighter-rouge">允许</code>授权后 Termux 可以方便的访问 SD 卡文件</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/android/image-20240314213753019.png" alt="image-20240314213753019" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 脚本允许后先后有如下两个选项，分别是背景色和字体</span>
Enter a number, leave blank to not to change: 14
Enter a number, leave blank to not to change: 22

<span class="c"># 想要继续更改挑选配色的话，可以运行脚本再次选择</span>
~/.termux/colors.sh
~/.termux/fonts.sh
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/android/image-20240314202804546.png" alt="image-20240314202804546" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看本机 ip </span>
ifconfig

<span class="c"># 启动 SSH 服务并配置自启动</span>
sshd <span class="o">&amp;&amp;</span> <span class="nb">echo </span>sshd <span class="o">&gt;&gt;</span> ~/.bashrc

<span class="c"># 查看当前用户</span>
<span class="nb">whoami</span>

<span class="c"># 设置密码</span>
passwd

<span class="c"># 查看 ssh 端口，一般为 8022</span>
netstat <span class="nt">-tnlp</span>
</code></pre></div></div>

<p>然后可以使用 xshell 等工具进行连接</p>

<p>proot-distro 支持几乎所有常用的 Linux 发行版：Alpine、Arch、Debian、ubuntu、manjaro 等等</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pkg <span class="nb">install </span>proot-distro <span class="nt">-y</span>

<span class="c"># 查看本机支持安装的 linux 环境</span>
proot-distro list

<span class="c"># 安装 ubuntu 环境，等待安装完成</span>
proot-distro <span class="nb">install </span>ubuntu

<span class="c"># 进入 ubuntu shell 环境</span>
proot-distro login ubuntu
</code></pre></div></div>]]></content><author><name>Nine</name></author><category term="Android" /><summary type="html"><![CDATA[Android 上终端模拟器简单使用]]></summary></entry><entry><title type="html">pgAdmin4 的安装与使用</title><link href="https://blog.nine.gt.tc/2024/03/11/linux-install-pgadmin4/" rel="alternate" type="text/html" title="pgAdmin4 的安装与使用" /><published>2024-03-11T00:00:00+08:00</published><updated>2024-03-11T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2024/03/11/linux-install-pgadmin4</id><content type="html" xml:base="https://blog.nine.gt.tc/2024/03/11/linux-install-pgadmin4/"><![CDATA[<p>pgAdmin4 是一个用于管理和维护 PostgreSQL 数据库的强大工具。它提供了一个图形化界面，使用户能够轻松地连接到数据库、创建表、运行 SQL 语句以及执行其他数据库管理任务。</p>

<h5 id="1yum-安装">1、yum 安装</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 临时修改为 permissive，同时 selinux 配置改为 disabled，下次重启服务器后会生效</span>
setenforce 0
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config

<span class="c"># 添加 pgAdmin 存储库</span>
wget <span class="nt">--no-check-certificate</span> https://ftp.postgresql.org/pub/pgadmin/pgadmin4/yum/pgadmin4-redhat-repo-2-1.noarch.rpm

rpm <span class="nt">-ivh</span> pgadmin4-redhat-repo-2-1.noarch.rpm

<span class="c"># centos7 及以下系统版本需要修改存储库地址</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s|ftp.postgresql.org/pub/pgadmin|pgadmin-archive.postgresql.org|'</span> /etc/yum.repos.d/pgadmin4.repo

<span class="c"># 查询可以安装的软件</span>
yum <span class="nt">-y</span> search pgadmin

<span class="c"># 安装 web 端软件</span>
yum <span class="nt">-y</span> <span class="nb">install </span>pgadmin4-web

<span class="c"># 修改默认端口 80 为 18080</span>
vim /etc/httpd/conf/httpd.conf

<span class="c"># 执行配置脚本，根据提示配置账号密码</span>
/usr/pgadmin4/bin/setup-web.sh

<span class="c"># 访问服务</span>
http://192.168.216.131:18080/pgadmin4/login
</code></pre></div></div>

<h5 id="2配置代理">2、配置代理</h5>

<p>使用 nginx 代理访问</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">location</span> <span class="n">/pgadmin4</span> <span class="p">{</span>
            <span class="kn">proxy_pass</span> <span class="s">http://192.168.216.131:18080</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">:</span><span class="nv">$server_port</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>]]></content><author><name>Nine</name></author><category term="PostgreSQL" /><summary type="html"><![CDATA[pgAdmin4 的安装与使用]]></summary></entry><entry><title type="html">Docker 的安装与使用</title><link href="https://blog.nine.gt.tc/2023/07/09/linux-install-docker/" rel="alternate" type="text/html" title="Docker 的安装与使用" /><published>2023-07-09T00:00:00+08:00</published><updated>2023-07-09T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2023/07/09/linux-install-docker</id><content type="html" xml:base="https://blog.nine.gt.tc/2023/07/09/linux-install-docker/"><![CDATA[<p>Docker 是一个开源的应用容器引擎，可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。 容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app），更重要的是容器性能开销极低。</p>

<h5 id="1centos-安装-docker">1、centos 安装 docker</h5>

<p>Docker 从 17.03 版本之后分为 CE 和 EE 两大版本。CE 即社区版（免费，支持周期 7 个月），EE 即企业版，强调安全，付费使用，支持周期 24 个月。</p>

<p>Docker CE 支持 64 位版本 CentOS 7，并且要求内核版本不低于 3.10， CentOS 7 满足最低内核的要求</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 卸载旧版 docker</span>
yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

<span class="c"># 设置 docker 存储库，docker 官网地址无法访问的可以使用国内其它镜像地址</span>
curl <span class="nt">-o</span> /etc/yum.repos.d/docker-ce.repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/download.docker.com/mirrors.tuna.tsinghua.edu.cn\/docker-ce/g'</span> /etc/yum.repos.d/docker-ce.repo

curl <span class="nt">-o</span> /etc/yum.repos.d/docker-ce.repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="c"># 安装最新版 docker 引擎和容器</span>
yum <span class="nt">-y</span> <span class="nb">install </span>docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

<span class="c"># 启动 docker</span>
systemctl start docker

<span class="c"># 开机自启</span>
systemctl <span class="nb">enable </span>docker

<span class="c"># 查看版本</span>
docker <span class="nt">-v</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装指定版本</span>
yum list docker-ce <span class="nt">--showduplicates</span> | <span class="nb">sort</span> <span class="nt">-r</span>
yum <span class="nb">install </span>docker-ce-3:24.0.0-1.el8 docker-ce-cli-3:24.0.0-1.el8 containerd.io docker-buildx-plugin docker-compose-plugin
</code></pre></div></div>

<blockquote>
  <p>官方文档：https://docs.docker.com/engine/install/centos/</p>
</blockquote>

<h5 id="2ubuntu-安装-docker">2、ubuntu 安装 docker</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Add Docker's official GPG key:</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>ca-certificates curl
<span class="nb">sudo install</span> <span class="nt">-m</span> 0755 <span class="nt">-d</span> /etc/apt/keyrings
<span class="nb">sudo </span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">sudo chmod </span>a+r /etc/apt/keyrings/docker.asc

<span class="c"># 设置 docker 存储库</span>
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">UBUNTU_CODENAME</span><span class="k">:-</span><span class="nv">$VERSION_CODENAME</span><span class="k">}</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
apt-get update

apt-get <span class="nb">install </span>docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

<span class="c"># 查看版本</span>
docker <span class="nt">-v</span>

<span class="c"># 启动 docker</span>
service docker start
</code></pre></div></div>

<h5 id="3配置镜像源">3、配置镜像源</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 国内拉取速度过慢时可以配置镜像源来访问</span>
<span class="nb">tee</span> /etc/docker/daemon.json <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
{
    "registry-mirrors": [
        "https://docker.m.daocloud.io",
        "https://docker.1panel.live",
        "https://hub.rat.dev"
    ],
    "dns": ["8.8.8.8", "8.8.4.4"]
}
</span><span class="no">EOF

</span><span class="c"># 重启 docker</span>
systemctl daemon-reload <span class="o">&amp;&amp;</span> systemctl restart docker
</code></pre></div></div>

<h5 id="4常用命令">4、常用命令</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 普通用户赋予 docker 命令执行权限</span>
usermod <span class="nt">-aG</span> docker guest

<span class="c"># 查看运行中的 docker 进程</span>
docker ps <span class="nt">-a</span>

<span class="c"># 启动/停止/重启容器</span>
docker start/stop/restart <span class="nb">id</span>/name

<span class="c"># 查看已安装的镜像</span>
docker images

<span class="c"># 删除某个容器</span>
docker <span class="nb">rm id</span>/name

<span class="c"># 删除某个镜像</span>
docker rmi <span class="nb">id</span>/name

<span class="c"># 获取 Docker 对象（容器、镜像、卷、网络等）的详细信息</span>
docker inspect <span class="nb">id</span>/name

<span class="c"># 实时显示 Docker 容器的资源使用情况</span>
docker stats
</code></pre></div></div>

<p><strong>参考</strong></p>

<ul>
  <li><a href="https://www.runoob.com/docker/docker-command-manual.html">Docker 命令大全 | 菜鸟教程</a></li>
</ul>]]></content><author><name>Nine</name></author><category term="Docker" /><summary type="html"><![CDATA[Docker 的安装与使用]]></summary></entry><entry><title type="html">PostgreSQL 的安装与使用</title><link href="https://blog.nine.gt.tc/2022/12/13/linux-install-postgresql/" rel="alternate" type="text/html" title="PostgreSQL 的安装与使用" /><published>2022-12-13T00:00:00+08:00</published><updated>2022-12-13T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2022/12/13/linux-install-postgresql</id><content type="html" xml:base="https://blog.nine.gt.tc/2022/12/13/linux-install-postgresql/"><![CDATA[<p>服务器系统版本为 centos 7.7。</p>

<h4 id="1软件安装">1、软件安装</h4>

<p>选择其中 1 种方式安装即可</p>

<h5 id="1yum-安装">(1)、yum 安装</h5>

<p>官方说明：<a href="https://www.postgresql.org/download/linux/redhat/">https://www.postgresql.org/download/linux/redhat/</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装 PostgreSQL 软件仓库</span>
yum <span class="nb">install</span> <span class="nt">-y</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm

<span class="c"># 查询支持的版本</span>
yum <span class="nt">-y</span> search <span class="s1">'PostgreSQL client programs'</span>

<span class="c"># 安装 PostgreSQL，默认安装目录：/var/lib/</span>
yum <span class="nb">install</span> <span class="nt">-y</span> postgresql15-server

<span class="c"># 初始化数据库</span>
/usr/pgsql-15/bin/postgresql-15-setup initdb

<span class="c"># 按需修改数据库配置文件</span>
vim /var/lib/pgsql/15/data/postgresql.conf

listen_addresses <span class="o">=</span> <span class="s1">'*'</span>
max_connections <span class="o">=</span> 200

logging_collector <span class="o">=</span> on
log_directory <span class="o">=</span> <span class="s1">'log'</span>
log_filename <span class="o">=</span> <span class="s1">'postgresql-%Y-%m-%d_%H%M%S.log'</span>
log_file_mode <span class="o">=</span> 0644
log_line_prefix <span class="o">=</span> <span class="s1">'%m %u %d %p %r %e'</span>
log_statement <span class="o">=</span> <span class="s1">'ddl'</span>

<span class="c"># 设置开机自启</span>
systemctl <span class="nb">enable </span>postgresql-15

<span class="c"># 启动数据库</span>
systemctl start postgresql-15

<span class="c"># 开放防火墙端口</span>
firewall-cmd <span class="nt">--add-port</span><span class="o">=</span>5432/tcp <span class="nt">--permanent</span>
firewall-cmd <span class="nt">--reload</span>
</code></pre></div></div>

<h5 id="2源码安装">(2)、源码安装</h5>

<p>源码安装包：<a href="https://www.postgresql.org/ftp/source">https://www.postgresql.org/ftp/source</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装依赖</span>
yum <span class="nb">install</span> <span class="nt">-y</span> gcc gcc-c++ make libicu-devel bison flex readline-devel zlib-devel wget vim

<span class="c"># 下载解压安装包</span>
wget https://ftp.postgresql.org/pub/source/v17.6/postgresql-17.6.tar.gz
<span class="nb">tar</span> <span class="nt">-zxvf</span> postgresql-17.6.tar.gz <span class="o">&amp;&amp;</span> <span class="nb">cd </span>postgresql-17.6
./configure <span class="nt">--prefix</span><span class="o">=</span>/usr/local/pgsql
make <span class="nt">-j2</span> <span class="o">&amp;&amp;</span> make <span class="nt">-j2</span> <span class="nb">install</span>

<span class="c"># 添加用户并创建数据目录</span>
useradd postgres
<span class="nb">mkdir</span> <span class="nt">-p</span> /data/pgsql/data
<span class="nb">chown</span> <span class="nt">-R</span> postgres:postgres /data/pgsql/data
<span class="nb">chown</span> <span class="nt">-R</span> postgres:postgres /usr/local/pgsql

<span class="c"># 配置环境变量</span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/profile <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="no">EOF</span><span class="sh">"
# postgresql
export PGHOME=/usr/local/pgsql
export PGDATA=/data/pgsql/data
export PATH=</span><span class="nv">$PGHOME</span><span class="sh">/bin:</span><span class="nv">$PATH</span><span class="sh">
</span><span class="no">EOF

</span><span class="c"># 使环境变量生效</span>
<span class="nb">source</span> /etc/profile

<span class="c"># 初始化数据库</span>
su - postgres
/usr/local/pgsql/bin/initdb <span class="nt">-D</span> /data/pgsql/data

<span class="c"># 修改数据库配置文件</span>
vim /data/pgsql/data/postgresql.conf

listen_addresses <span class="o">=</span> <span class="s1">'*'</span>
max_connections <span class="o">=</span> 4000

shared_buffers <span class="o">=</span> 4GB
work_mem <span class="o">=</span> 64MB
maintenance_work_mem <span class="o">=</span> 1GB
effective_cache_size <span class="o">=</span> 12GB
wal_buffers <span class="o">=</span> 16MB
checkpoint_completion_target <span class="o">=</span> 0.9

logging_collector <span class="o">=</span> on
log_directory <span class="o">=</span> <span class="s1">'log'</span>
log_filename <span class="o">=</span> <span class="s1">'postgresql-%Y-%m-%d_%H%M%S.log'</span>
log_file_mode <span class="o">=</span> 0644
log_line_prefix <span class="o">=</span> <span class="s1">'%m %u %d %p %r %e'</span>
log_statement <span class="o">=</span> <span class="s1">'ddl'</span>

<span class="c"># 启动服务</span>
/usr/local/pgsql/bin/pg_ctl <span class="nt">-D</span> /data/pgsql/data start

<span class="c"># 复制源码包里的启动脚本至 /etc/init.d 目录下，并加执行权限</span>
<span class="nb">cp </span>postgresql-17.6/contrib/start-scripts/linux /etc/init.d/postgresql
<span class="nb">chmod</span> +x /etc/init.d/postgresql

<span class="c"># 修改数据目录</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s|^PGDATA=.*|PGDATA="/data/pgsql/data"|'</span> /etc/init.d/postgresql

<span class="c"># 设置开机启动</span>
chkconfig <span class="nt">--add</span> postgresql

<span class="c"># 启动服务</span>
systemctl start postgresql

<span class="c"># 服务状态</span>
systemctl status postgresql

<span class="c"># 重启数据库</span>
/usr/local/pgsql/bin/pg_ctl <span class="nt">-D</span> /data/pgsql/data rstart

<span class="c"># 开放防火墙端口</span>
firewall-cmd <span class="nt">--add-port</span><span class="o">=</span>5432/tcp <span class="nt">--permanent</span>
firewall-cmd <span class="nt">--reload</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">listen_addresses</code>：* 为允许服务器监听所有可用的网络接口，允许远程连接</p>

  <p><code class="language-plaintext highlighter-rouge">max_connections</code>：决定允许的最大数据库连接数。过多的连接会增加系统开销和资源竞争。通常可以使用连接池工具（如 PgBouncer）来控制并发连接数；</p>

  <p><code class="language-plaintext highlighter-rouge">shared_buffers</code>：这是 PostgreSQL 用于缓存表数据的共享内存区域，通常建议设置为物理内存的 25%-40%。如果设置过低，会导致频繁的磁盘访问；设置过高则会占用操作系统内存，减少可用的文件缓存；</p>

  <p><code class="language-plaintext highlighter-rouge">work_mem</code>：每个查询操作（如排序、哈希表）所使用的内存。这个参数是每个查询连接单独分配的，因此需要根据查询复杂度和并发量合理设置。如果过小，查询需要频繁进行磁盘交换；过大会导致内存不足。典型值在 10MB-100MB 之间；</p>

  <p><code class="language-plaintext highlighter-rouge">maintenance_work_mem</code>：控制 PostgreSQL 在执行维护操作时使用的内存大小，比如创建索引、VACUUM。推荐设置为较大的值，尤其是在大规模数据集上操作时；</p>

  <p><code class="language-plaintext highlighter-rouge">effective_cache_size</code>：PostgreSQL 根据此参数判断系统可用的文件系统缓存大小，从而决定是否使用索引扫描或全表扫描。建议设置为物理内存的 50%-75%；</p>

  <p><code class="language-plaintext highlighter-rouge">wal_buffers</code>：建议设置为 shared_buffers 的 1/32，用于缓冲 WAL 数据，避免频繁写入磁盘；</p>

  <p><code class="language-plaintext highlighter-rouge">checkpoint_completion_target</code>：设置为接近 1 的值可以平滑 WAL 日志写入压力，减少突发I/O 操作。</p>

  <p><code class="language-plaintext highlighter-rouge">logging_collector</code>：开启日志收集器，用于收集数据库服务器的日志信息</p>

  <p><code class="language-plaintext highlighter-rouge">log_directory</code>：日志文件的存储目录为 pg_log</p>

  <p><code class="language-plaintext highlighter-rouge">log_filename</code>：日志文件名包含月份和日期信息</p>

  <p><code class="language-plaintext highlighter-rouge">log_file_mode</code>：日志文件权限</p>

  <p><code class="language-plaintext highlighter-rouge">log_line_prefix</code>：日志行前缀（%m 时间，%u 用户名称，%d 数据库名称，%r 客户端 IP 和端口，%e sql 语句）</p>

  <p><code class="language-plaintext highlighter-rouge">log_statement</code>：none、ddl、mod、all 控制记录哪些 SQL 语句。none 不记录，ddl 记录所有数据定义命令，比如 CREATE、ALTER、DROP 语句。mod 记录所有 ddl 语句,加上数据修改语句INSERT、UPDATE 等，all 记录所有执行的语句，将此配置设置为 all 可跟踪整个数据库执行的 SQL 语句</p>
</blockquote>

<h4 id="2密码修改">2、密码修改</h4>

<p>安装完成后修改数据库密码并配置密码认证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 数据库密码修改</span>
su - postgres
psql
alter user postgres with password <span class="s1">'pgsqlabcd!'</span><span class="p">;</span>

<span class="c"># 创建用户</span>
CREATE USER testuser with password <span class="s1">'pgsqlabcd!'</span><span class="p">;</span>

<span class="c"># 增加允许连接的 ip 地址，0.0.0.0/0 表示任意地址，192.168.1.11/32 表示仅允许 192.168.1.11 连接</span>
vim <span class="nv">$PGDATA</span>/pg_hba.conf

host    all             all             0.0.0.0/0               scram-sha-256
host    all             all             192.168.1.11/32         scram-sha-256

<span class="c"># 根据 postgresql.conf 中的 shared-buffers 值计算需要的大页数量</span>
/usr/local/pgsql/bin/postgres <span class="nt">-D</span> <span class="nv">$PGDATA</span> <span class="nt">--shared-buffers</span><span class="o">=</span>12GB <span class="nt">--huge-pages</span><span class="o">=</span>on <span class="nt">-C</span> shared_buffers

<span class="c"># 修改系统配置</span>
vim /etc/sysctl.conf
vm.nr_hugepages <span class="o">=</span> 6146

<span class="c"># 使之生效</span>
sysctl <span class="nt">-p</span>

<span class="c"># 检查大页是否分配成功</span>
<span class="nb">cat</span> /proc/meminfo | <span class="nb">grep </span>Huge

<span class="c"># 重启数据库（yum 安装方式）</span>
systemctl restart postgresql-15

<span class="c"># 重启数据库（源码安装方式）</span>
systemctl restart postgresql
</code></pre></div></div>

<blockquote>
  <p>在传统的操作系统内存管理中，内存被划分为许多小块，通常每块是 <strong>4KB</strong>（这个值取决于架构，x86_64 默认是 4KB），这被称为“基础页”。</p>

  <p><strong>问题：</strong> 当一个像 PostgreSQL 这样需要大量内存的进程（例如，<code class="language-plaintext highlighter-rouge">shared_buffers</code> 设置为几十GB）运行时，它需要管理成千上万甚至数百万个这些 4KB 的小页面。这会导致：</p>

  <ul>
    <li><strong>更高的 CPU 开销：</strong> 操作系统需要维护更多的页表项（Page Table Entries）。</li>
    <li><strong>更高的 TLB 压力：</strong> TLB（Translation Lookaside Buffer）是 CPU 中的一个高速缓存，用于快速将虚拟地址转换为物理地址。TLB 容量很小，如果进程需要频繁访问大量分散的 4KB 页面，会导致 TLB 缓存未命中（TLB miss），CPU 就不得不去访问更慢的主内存来查找地址转换关系，这会显著降低性能。</li>
  </ul>

  <p><strong>解决方案：大页（Huge Pages）</strong></p>
  <ul>
    <li>大页是另一种内存页大小，通常是 <strong>2MB</strong> 或 <strong>1GB</strong>（相比之下，基础页是 4KB）。</li>
    <li>通过使用 2MB 的大页，同样管理 16GB 的内存，操作系统只需要处理 <code class="language-plaintext highlighter-rouge">16GB / 2MB = 8192</code> 个页表项，而不是 <code class="language-plaintext highlighter-rouge">16GB / 4KB = 4,194,304</code> 个。这减少了超过 99% 的页表项数量！</li>
    <li>TLB 可以缓存更多的地址转换关系，从而极大减少 TLB miss，提高内存访问效率。</li>
  </ul>
</blockquote>]]></content><author><name>Nine</name></author><category term="PostgreSQL" /><summary type="html"><![CDATA[PostgreSQL 的安装与使用]]></summary></entry><entry><title type="html">内网下使用 Nginx 转发邮件</title><link href="https://blog.nine.gt.tc/2022/03/25/nginx-forward-mail/" rel="alternate" type="text/html" title="内网下使用 Nginx 转发邮件" /><published>2022-03-25T00:00:00+08:00</published><updated>2022-03-25T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2022/03/25/nginx-forward-mail</id><content type="html" xml:base="https://blog.nine.gt.tc/2022/03/25/nginx-forward-mail/"><![CDATA[<p>内网邮件通过 Nginx 代理进行转发。</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/nginx/image-20220325133718280.png" alt="image-20220325133718280" /></p>

<h5 id="1安装-stream">1、安装 stream</h5>

<p>使用 stream 方式代理 smtp 协议的邮件服务，需安装 stream 模块</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看已安装模块</span>
./nginx <span class="nt">-V</span>

<span class="c"># 编译时需加上 stream 模块</span>
./configure <span class="nt">--prefix</span><span class="o">=</span>/usr/local/nginx <span class="nt">--with-stream</span> ...
make <span class="o">&amp;&amp;</span> make <span class="nb">install</span>
</code></pre></div></div>

<h5 id="2nginx-配置">2、nginx 配置</h5>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">stream</span> <span class="p">{</span>
    <span class="c1"># 邮件转发</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">8765</span><span class="p">;</span>
        <span class="kn">proxy_connect_timeout</span> <span class="s">5s</span><span class="p">;</span>
        <span class="kn">proxy_timeout</span> <span class="s">5s</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="nf">smtp.qq.com</span><span class="p">:</span><span class="mi">587</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="3内网测试邮件发送">3、内网测试邮件发送</h5>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/nginx/image-20220325140602124.png" alt="image-20220325140602124" /></p>]]></content><author><name>Nine</name></author><category term="Nginx" /><summary type="html"><![CDATA[内网邮件转发]]></summary></entry><entry><title type="html">Gitlab 的安装与使用</title><link href="https://blog.nine.gt.tc/2021/12/30/linux-install-gitlab/" rel="alternate" type="text/html" title="Gitlab 的安装与使用" /><published>2021-12-30T00:00:00+08:00</published><updated>2021-12-30T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2021/12/30/linux-install-gitlab</id><content type="html" xml:base="https://blog.nine.gt.tc/2021/12/30/linux-install-gitlab/"><![CDATA[<p>Centos7 下 Gitlab 的安装配置与备份恢复。</p>

<h5 id="1gitlab-介绍">1、Gitlab 介绍</h5>

<p>GitLab 是利用 Ruby on Rails 一个开源的版本管理系统，实现一个自托管的 Git 项目仓库，可通过 Web 界面进行访问公开的或者私人项目。</p>

<p>GitLab 能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序 (Wall) 进行交流。</p>

<p>它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找</p>

<p><strong>Gitlab 服务构成</strong></p>

<ul>
  <li>Nginx：静态 web 服务器</li>
  <li>gitlab-shell：用于处理 Git 命令和修改 authorized keys 列表</li>
  <li>gitlab-workhorse: 轻量级的反向代理服务器</li>
  <li>logrotate：日志文件管理工具</li>
  <li>postgresql：数据库</li>
  <li>redis：缓存数据库</li>
  <li>sidekiq：用于在后台执行队列任务（异步执行）</li>
  <li>unicorn：An HTTP server for Rack applications，GitLab Rails 应用是托管在这个服务器上面的</li>
</ul>

<p><strong>gitlab-ee 和 gitlab-ce 的区别</strong>
关于 gitlab-ee（企业版）和 gitlab-ce（社区版），二者是基于同样的核心代码进行开发，只是 gitlab-ee 功能更强大，但需要付费使用，有 30 天试用期。但试用期过后如果不付费，它就跟 gitlab-ce 功能是完全一样的，只是需要付费的功能无法再继续使用而已。</p>

<h5 id="2rpm-包安装">2、rpm 包安装</h5>

<p>安装要求：<a href="https://docs.gitlab.com/ee/install/requirements.html">https://docs.gitlab.com/ee/install/requirements.html</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装依赖</span>
yum <span class="nb">install</span> <span class="nt">-y</span> curl policycoreutils-python openssh-server perl

<span class="c"># 启动ssh</span>
systemctl <span class="nb">enable </span>sshd
systemctl start sshd

<span class="c"># 将 http 和 https 加入防火墙策略，并重启防火墙。</span>
systemctl start firewalld
firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-service</span><span class="o">=</span>http
firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-service</span><span class="o">=</span>https
systemctl reload firewalld
systemctl <span class="nb">enable </span>firewalld

<span class="c"># 安装 postfix 发邮件功能，若使用外部 SMTP 服务器发送邮件可以不必安装</span>
yum <span class="nb">install</span> <span class="nt">-y</span> postfix
systemctl <span class="nb">enable </span>postfix
systemctl start postfix
</code></pre></div></div>

<ul>
  <li>
    <p>离线安装</p>

    <p>rpm 镜像：<a href="https://packages.gitlab.com/gitlab/gitlab-ee">https://packages.gitlab.com/gitlab/gitlab-ee</a></p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载安装 rpm 包，本机为 centos7</span>
wget <span class="nt">--content-disposition</span> https://packages.gitlab.com/gitlab/gitlab-ee/packages/el/7/gitlab-ee-14.6.0-ee.0.el7.x86_64.rpm/download.rpm
  
rpm <span class="nt">-ivh</span> gitlab-ee-14.6.0-ee.0.el7.x86_64.rpm
</code></pre></div>    </div>
  </li>
  <li>
    <p>在线安装</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 配置 gitlab-ce 的 yum 库</span>
curl <span class="nt">-sS</span> https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | <span class="nb">sudo </span>bash
  
<span class="c"># 在线安装gitlab-ee</span>
yum <span class="nb">install</span> <span class="nt">-y</span> gitlab-ee
  
<span class="c"># 如果要安装指定的版本，在后面填上版本号即可</span>
yum <span class="nb">install</span> <span class="nt">-y</span> gitlab-ee-14.6.0
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="3docker-安装">3、docker 安装</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 拉取镜像</span>
docker pull gitlab/gitlab-ee:14.6.0-ee.0

<span class="c"># 运行容器</span>
docker run <span class="nt">--detach</span> <span class="se">\</span>
<span class="nt">--publish</span> 22333:80 <span class="nt">--publish</span> 18443:443 <span class="nt">--publish</span> 18022:22 <span class="se">\</span>
<span class="nt">--name</span> gitlab <span class="se">\</span>
<span class="nt">--restart</span> always <span class="se">\</span>
<span class="nt">--volume</span> /data/gitlab/etc:/etc/gitlab <span class="se">\</span>
<span class="nt">--volume</span> /data/gitlab/log:/var/log/gitlab <span class="se">\</span>
<span class="nt">--volume</span> /data/gitlab/data:/var/opt/gitlab <span class="se">\</span>
<span class="nt">--env</span> <span class="nv">GITLAB_OMNIBUS_CONFIG</span><span class="o">=</span><span class="s2">"external_url 'http://192.168.0.250';"</span> <span class="se">\</span>
gitlab/gitlab-ee:14.6.0-ee.0

<span class="c"># 查看日志</span>
docker logs <span class="nt">--tail</span> 300 <span class="nt">-f</span> gitlab

<span class="c"># 默认管理员 root，查看密码，登录后修改密码（默认密码有效期只有24小时），访问服务：http://192.168.0.250:22333</span>
<span class="nb">cat</span> /data/gitlab/etc/initial_root_password
</code></pre></div></div>

<h5 id="4修改配置">4、修改配置</h5>

<p>修改 Gitlab 主配置文件：<code class="language-plaintext highlighter-rouge">vim /etc/gitlab/gitlab.rb</code></p>

<p>在 vim 下输入<code class="language-plaintext highlighter-rouge">/关键字</code> 快速查找，按 n 键查找下一个</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 改为需要配置的域名或 IP，内网则为本机 IP</span>
<span class="s">external_url 'http://192.168.0.250'</span>

<span class="c1"># 修改监听端口，默认 80</span>
<span class="s">nginx['listen_port'] = </span><span class="m">22333</span>

<span class="c1"># ssh 地址配置，端口保持与 ssh 登录端口一致</span>
<span class="s">gitlab_rails['gitlab_ssh_host'] = '192.168.0.250'</span>
<span class="s">gitlab_rails['gitlab_shell_ssh_port'] = </span><span class="m">30001</span>

<span class="c1"># Email 设置</span>
<span class="s">gitlab_rails['gitlab_email_enabled'] = </span><span class="no">true</span>
<span class="s">gitlab_rails['gitlab_email_from'] = 'xxx@qq.com'</span>      <span class="c1"># 自己的邮箱</span>
<span class="s">gitlab_rails['gitlab_email_display_name'] = 'Name'</span>    <span class="c1"># gitlab 给你发邮件时使用的名字。</span>
</code></pre></div></div>

<p>以下配置按需修改</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 若未安装 postfix，则需要配置 smtp</span>
<span class="s">gitlab_rails['smtp_enable'] = </span><span class="no">true</span>
<span class="s">gitlab_rails['smtp_address'] = "smtp.qq.com"</span>
<span class="s">gitlab_rails['smtp_port'] = </span><span class="m">465</span>
<span class="s">gitlab_rails['smtp_user_name'] = "xxxx@qq.com"</span>
<span class="s">gitlab_rails['smtp_password'] = "xxxxxxxxxxx"</span>
<span class="s">gitlab_rails['smtp_domain'] = "qq.com"</span>
<span class="s">gitlab_rails['smtp_authentication'] = "login"</span>
<span class="s">gitlab_rails['smtp_enable_starttls_auto'] = </span><span class="no">true</span>
<span class="s">gitlab_rails['smtp_tls'] = </span><span class="no">false</span>

<span class="c1"># 关闭 prometheus 监控（内存低时可以关闭节省资源）</span>
<span class="s">prometheus['enable'] = </span><span class="no">false</span>
<span class="s">prometheus['monitor_kubernetes'] = </span><span class="no">false</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">/etc/gitlab/gitlab.rb</code>：主配置文件，包含外部URL、仓库目录、备份目录等</p>

  <p><code class="language-plaintext highlighter-rouge">/etc/gitlab/gitlab-secrets.json</code>：（执行 gitlab-ctl reconfigure 命令行后生成），包含各类密钥的加密信息</p>

  <p>smtp 邮件服务商配置：<a href="https://docs.gitlab.com/omnibus/settings/smtp.html">https://docs.gitlab.com/omnibus/settings/smtp.html</a></p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 重新应用 gitlab 的配置，每次修改 /etc/gitlab/gitlab.rb 文件之后执行</span>
gitlab-ctl reconfigure

<span class="c"># 查看初始密码</span>
<span class="nb">cat</span> /etc/gitlab/initial_root_password

<span class="c"># 或者直接重置密码，此命令从 13.9 版本后可用</span>
gitlab-rake <span class="s2">"gitlab:password:reset"</span>

<span class="c"># 开放端口</span>
firewall-cmd <span class="nt">--zone</span><span class="o">=</span>public <span class="nt">--permanent</span> <span class="nt">--add-port</span><span class="o">=</span>22333/tcp
firewall-cmd <span class="nt">--reload</span>

<span class="c"># 查看状态</span>
gitlab-ctl status
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/git/image-20220404235024738.png" alt="image-20220404235024738" /></p>

<p>安装完成后建议关闭注册功能</p>

<h5 id="5备份恢复">5、备份恢复</h5>

<p>默认备份目录：<code class="language-plaintext highlighter-rouge">/var/opt/gitlab/backups</code></p>

<p>修改 gitlab 配置文件：<code class="language-plaintext highlighter-rouge">vim /etc/gitlab/gitlab.rb</code></p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 指定备份后数据存放的路径、权限、时间配置
</span><span class="err">gitlab_rails</span><span class="nn">['manage_backup_path']</span> <span class="err">=</span> <span class="err">true</span>                  <span class="c">#292行      开启备份功能
</span><span class="err">gitlab_rails</span><span class="nn">['backup_path']</span> <span class="err">=</span> <span class="err">"/gitlab_backup"</span>             <span class="c">#293行      指定备份的路径
</span><span class="err">gitlab_rails</span><span class="nn">['backup_archive_permissions']</span> <span class="err">=</span> <span class="err">0644</span>          <span class="c">#296行      备份文件的权限
</span><span class="err">gitlab_rails</span><span class="nn">['backup_keep_time']</span> <span class="err">=</span> <span class="err">604800</span>                  <span class="c">#301行      备份保留时间（保留 7 天）
</span></code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建备份目录并授权</span>
<span class="nb">mkdir</span> /gitlab_backup
<span class="nb">chown</span> <span class="nt">-R</span> git:root /gitlab_backup/

<span class="c"># 重新生效 gitlab 配置</span>
gitlab-ctl reconfigure

<span class="c"># 手动备份</span>
gitlab-rake gitlab:backup:create

<span class="c"># 定时备份</span>
0 3 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /opt/gitlab/bin/gitlab-rake gitlab:backup:create <span class="o">&gt;&gt;</span> /gitlab_backup/crontab.log 2&gt;&amp;1
</code></pre></div></div>

<p>gitlab 数据恢复只能还原到与备份文件相同的 gitlab 版本</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载安装与备份相同版本的 gitlab</span>
wget <span class="nt">--content-disposition</span> https://packages.gitlab.com/gitlab/gitlab-ee/packages/el/7/gitlab-ee-13.10.3-ee.0.el7.x86_64.rpm/download.rpm

rpm <span class="nt">-ivh</span> gitlab-ee-13.10.3-ee.0.el7.x86_64.rpm

<span class="c"># 参考上述安装修改配置</span>
vim /etc/gitlab/gitlab.rb
gitlab-ctl reconfigure

<span class="c"># 停止相关数据连接服务</span>
gitlab-ctl stop unicorn
gitlab-ctl stop sidekiq

<span class="c"># 将备份文件放在相应的备份路径下</span>
<span class="nb">mv </span>1618907900_2021_04_20_13.10.3-ee_gitlab_backup.tar /var/opt/gitlab/backups/
<span class="nb">chmod </span>777 1618907900_2021_04_20_13.10.3-ee_gitlab_backup.tar

<span class="c"># gitlab 的恢复操作会先将当前所有的数据清空</span>
gitlab-rake gitlab:backup:restore <span class="nv">BACKUP</span><span class="o">=</span>1618907900_2021_04_20_13.10.3-ee
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/git/image-20220317225958638.png" alt="image-20220317225958638" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 重启 gitlab</span>
gitlab-ctl restart

<span class="c"># 恢复命令完成后，可以 check 检查一下恢复情况</span>
gitlab-rake gitlab:check <span class="nv">SANITIZE</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<p>其它命令</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 日志目录：/var/log/gitlab</span>
<span class="c"># 查看 nginx 访问日志</span>
gitlab-ctl <span class="nb">tail </span>nginx/gitlab_acces.log	

<span class="c"># 查看 postgresql 日志</span>
gitlab-ctl <span class="nb">tail </span>postgresql

<span class="c"># 查看所有服务</span>
gitlab-ctl service-list

<span class="c"># 检查配置并启动</span>
gitlab-ctl check-config
</code></pre></div></div>

<blockquote>
  <p>docker 方式安装需进入容器内执行上述相关备份恢复命令：<code class="language-plaintext highlighter-rouge">docker exec -it gitlab bash</code></p>
</blockquote>

<h5 id="6其他">6、其他</h5>

<p><strong>修改 root 密码</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 直接重置密码，此命令从 13.9 版本后可用</span>
gitlab-rake <span class="s2">"gitlab:password:reset"</span>

<span class="c"># 进控制台修改</span>
gitlab-rails console <span class="nt">-e</span> production
user.password <span class="o">=</span> <span class="s1">'new_password'</span>
user.password_confirmation <span class="o">=</span> <span class="s1">'new_password'</span>
user.save!
<span class="nb">exit</span>
</code></pre></div></div>

<ul>
  <li><a href="https://docs.gitlab.com/ee/security/reset_user_password.html#use-a-rails-console">https://docs.gitlab.com/ee/security/reset_user_password.html#use-a-rails-console</a></li>
</ul>

<p><strong>添加SSL认证</strong></p>

<p>参考 <a href="https://blog.csdn.net/qq_43626147/article/details/109160229">https://blog.csdn.net/qq_43626147/article/details/109160229</a></p>

<p><strong>Gitlab 管理页面保存后报 500 错误</strong></p>

<p>首先，遍历数据库中所有可能的加密值，验证它们是否可使用 gitlab-secrets.json解密。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab-rake gitlab:doctor:secrets
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/git/image-20211230095708439.png" alt="image-20211230095708439" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab-rails dbconsole
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Clear project tokens</span>
<span class="k">UPDATE</span> <span class="n">projects</span> <span class="k">SET</span> <span class="n">runners_token</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">runners_token_encrypted</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

<span class="c1">-- Clear project tokens</span>
<span class="k">UPDATE</span> <span class="n">projects</span> <span class="k">SET</span> <span class="n">runners_token</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">runners_token_encrypted</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="c1">-- Clear group tokens</span>
<span class="k">UPDATE</span> <span class="n">namespaces</span> <span class="k">SET</span> <span class="n">runners_token</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">runners_token_encrypted</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="c1">-- Clear instance tokens</span>
<span class="k">UPDATE</span> <span class="n">application_settings</span> <span class="k">SET</span> <span class="n">runners_registration_token_encrypted</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="c1">-- Clear key used for JWT authentication</span>
<span class="c1">-- This may break the $CI_JWT_TOKEN job variable:</span>
<span class="c1">-- https://gitlab.com/gitlab-org/gitlab/-/issues/325965</span>
<span class="k">UPDATE</span> <span class="n">application_settings</span> <span class="k">SET</span> <span class="n">encrypted_ci_jwt_signing_key</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="c1">-- Clear runner tokens</span>
<span class="k">UPDATE</span> <span class="n">ci_runners</span> <span class="k">SET</span> <span class="n">token</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">token_encrypted</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

<span class="c1">-- truncate web_hooks table</span>
<span class="k">TRUNCATE</span> <span class="n">web_hooks</span> <span class="k">CASCADE</span><span class="p">;</span>
</code></pre></div></div>

<p><strong>参考</strong></p>

<ul>
  <li><a href="https://docs.gitlab.com/ee/administration/raketasks/doctor.html#verify-database-values-can-be-decrypted-using-the-current-secrets">Doctor Rake tasks</a></li>
  <li><a href="https://docs.gitlab.com/ee/raketasks/backup_restore.html#reset-runner-registration-tokens">Reset runner registration tokens</a></li>
  <li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/26171">Issue-26171</a></li>
  <li><a href="https://www.cnblogs.com/hgzero/p/14088215.html">Gitlab的安装及使用</a></li>
</ul>]]></content><author><name>Nine</name></author><category term="Gitlab" /><summary type="html"><![CDATA[Gitlab 的安装与简单配置]]></summary></entry><entry><title type="html">Elasticsearch 的安装与使用</title><link href="https://blog.nine.gt.tc/2021/11/17/linux-install-elasticsearch/" rel="alternate" type="text/html" title="Elasticsearch 的安装与使用" /><published>2021-11-17T00:00:00+08:00</published><updated>2021-11-17T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2021/11/17/linux-install-elasticsearch</id><content type="html" xml:base="https://blog.nine.gt.tc/2021/11/17/linux-install-elasticsearch/"><![CDATA[<p>Elasticsearch 是一个高度可伸缩的开源全文搜索和分析引擎，它可以快速和接近实时地存储、搜索和分析大量数据。</p>

<h5 id="1安装-elasticsearch">1、安装 Elasticsearch</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载安装</span>
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.12.0-x86_64.rpm
rpm <span class="nt">-ivh</span> elasticsearch-7.12.0-x86_64.rpm
</code></pre></div></div>

<p>修改 ES 配置文件 elasticsearch.yml：<code class="language-plaintext highlighter-rouge">vim /etc/elasticsearch/elasticsearch.yml</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">cluster.name</span><span class="pi">:</span> <span class="s">scientific-research</span>
<span class="na">node.name</span><span class="pi">:</span> <span class="s">node-1</span>
<span class="na">network.host</span><span class="pi">:</span> <span class="s">192.168.0.250</span>
<span class="na">http.port</span><span class="pi">:</span> <span class="m">9200</span>
<span class="na">cluster.initial_master_nodes</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">node-1"</span><span class="pi">]</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 设置开机自启</span>
systemctl <span class="nb">enable </span>elasticsearch.service

<span class="c"># 启动elasticsearch</span>
systemctl start elasticsearch

<span class="c"># 查看状态</span>
systemctl status elasticsearch

<span class="c"># 开放端口</span>
firewall-cmd <span class="nt">--zone</span><span class="o">=</span>public <span class="nt">--permanent</span> <span class="nt">--add-port</span><span class="o">=</span>9200/tcp
firewall-cmd <span class="nt">--reload</span>
</code></pre></div></div>

<p>浏览器打开：http://192.168.0.250:9200，出现以下信息表示启动成功</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20220316170035522.png" alt="image-20220316170035522" /></p>

<h5 id="2安装ik分词器">2、安装ik分词器</h5>

<p>下载与 ES 相同版本的 ik 分词器</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装 ik 分词器</span>
<span class="nb">cd</span> /usr/share/elasticsearch/plugins
<span class="nb">mkdir </span>ik
<span class="nb">cd </span>ik
wget https://github.com/medcl/elasticsearch-analysis-
ik/releases/download/v7.12.0/elasticsearch-analysis-ik-7.12.0.zip
unzip elasticsearch-analysis-ik-7.12.0.zip
<span class="nb">rm </span>elasticsearch-analysis-ik-7.12.0.zip

<span class="c"># 重启服务</span>
systemctl restart elasticsearch
</code></pre></div></div>

<h5 id="3分词器的使用">3、分词器的使用</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 使用 ES 内置分词器，只会将文字按个拆分</span>
curl <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-XGET</span> <span class="s1">'192.168.0.250:9200/_analyze?pretty'</span> <span class="nt">-d</span> <span class="s1">'{"text":"飞流直下三千尺"}'</span>

<span class="c"># 使用 analyzer-ik 分词器</span>
curl <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-XGET</span> <span class="s1">'192.168.0.250:9200/_analyze?pretty'</span> <span class="nt">-d</span> <span class="s1">'{"analyzer":"ik_max_word","text":"飞流直下三千尺"}'</span>
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20220316163049837.png" alt="image-20220316163049837" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 配置自定义词库</span>
vim /usr/share/elasticsearch/plugins/ik/config/IKAnalyzer.cfg.xml

<span class="c"># 增加自定义词库</span>
<span class="nb">echo</span> <span class="s1">'三千尺'</span> <span class="o">&gt;</span> /usr/share/elasticsearch/plugins/ik/config/my.dic

<span class="c"># 重启 es 服务</span>
systemctl restart elasticsearch
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20220316163012921.png" alt="image-20220316163012921" /></p>

<p>使用自定义词库后的分词效果</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20220316162747400.png" alt="image-20220316162747400" /></p>

<h5 id="4head-插件安装">4、head 插件安装</h5>

<p>head 插件是 ES 的一个可视化管理插件，用来监视 ES 的状态，并通过 head 客户端和 ES 服务进行交互，比如创建映射、创建索引等。</p>

<p>安装方式见：https://github.com/mobz/elasticsearch-head</p>

<p>本文使用浏览器插件方式：https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20220316170641309.png" alt="image-20220316170641309" /></p>]]></content><author><name>Nine</name></author><category term="Elasticsearch" /><summary type="html"><![CDATA[Elasticsearch 的简单配置和使用]]></summary></entry><entry><title type="html">MySQL 的安装与使用</title><link href="https://blog.nine.gt.tc/2021/10/17/linux-install-mysql/" rel="alternate" type="text/html" title="MySQL 的安装与使用" /><published>2021-10-17T00:00:00+08:00</published><updated>2021-10-17T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2021/10/17/linux-install-mysql</id><content type="html" xml:base="https://blog.nine.gt.tc/2021/10/17/linux-install-mysql/"><![CDATA[<p>使用离线包方式安装 MySQL。</p>

<h5 id="1下载-mysql">1、下载 MySQL</h5>

<p>官网：<a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a>，本机为 Centos 7.7</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/mysql/image-20211017190131138.png" alt="image-20211017190131138" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载安装包</span>
wget https://cdn.mysql.com/archives/mysql-8.0/mysql-8.0.34-linux-glibc2.12-x86_64.tar.xz

<span class="c"># 查看系统自带的 Mariadb</span>
rpm <span class="nt">-qa</span> | <span class="nb">grep </span>mariadb

<span class="c"># 卸载系统自带的 Mariadb</span>
rpm <span class="nt">-e</span> <span class="nt">--nodeps</span> mariadb-libs-5.5.64-1.el7.x86_64

<span class="c"># 查看是否安装过 MySQL，删除相关目录和配置文件</span>
rpm <span class="nt">-qa</span> | <span class="nb">grep </span>mysql

<span class="c"># 安装依赖</span>
yum <span class="nb">install </span>libaio
</code></pre></div></div>

<h5 id="2环境配置">2、环境配置</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 解压</span>
<span class="nb">tar</span> <span class="nt">-xvf</span> mysql-8.0.34-linux-glibc2.12-x86_64.tar.xz <span class="nt">-C</span> /data
<span class="nb">mv</span> /data/mysql-8.0.34-linux-glibc2.12-x86_64 /data/mysql

<span class="c"># 创建数据目录，修改目录权限</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /data/mysql/<span class="o">{</span>data,conf,run,log<span class="o">}</span>
<span class="nb">chmod </span>750 /data/mysql/data

<span class="c"># 创建 mysql 组</span>
groupadd mysql

<span class="c"># 创建 mysql 用户，使用 -g 参数指定组，-r 参数表示 mysql 用户是系统用户，不可用于登录系统</span>
useradd <span class="nt">-r</span> <span class="nt">-g</span> mysql mysql

<span class="c"># 修改 mysql 的用户和组</span>
<span class="nb">chown</span> <span class="nt">-R</span> mysql:mysql /data/mysql

<span class="c"># 配置环境变量</span>
<span class="nb">echo</span> <span class="s1">'export PATH=$PATH:/data/mysql/bin'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">source</span> /etc/profile
</code></pre></div></div>

<p>创建配置文件：<code class="language-plaintext highlighter-rouge">vim /etc/my.cnf</code></p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[mysql]</span>
<span class="c"># 设置 MySQL 客户端默认字符集
</span><span class="py">default-character-set</span><span class="p">=</span><span class="s">utf8</span>
<span class="py">socket</span><span class="p">=</span><span class="s">/data/mysql/run/mysql.sock</span>

<span class="nn">[mysqld]</span>
<span class="py">port</span><span class="p">=</span><span class="s">3306</span>
<span class="py">socket</span><span class="p">=</span><span class="s">/data/mysql/run/mysql.sock</span>
<span class="py">pid-file</span><span class="p">=</span><span class="s">/data/mysql/run/mysql.pid</span>

<span class="py">mysqlx_port</span> <span class="p">=</span> <span class="s">33060</span>
<span class="py">mysqlx_socket</span><span class="p">=</span><span class="s">/data/mysql/run/mysqlx.sock</span>

<span class="c"># 设置时区
</span><span class="py">default-time-zone</span><span class="p">=</span><span class="s">'+8:00'</span>
<span class="py">log_timestamps</span> <span class="p">=</span> <span class="s">SYSTEM</span>

<span class="c"># 设置 MySQL 的安装目录、数据目录
</span><span class="py">basedir</span><span class="p">=</span><span class="s">/data/mysql</span>
<span class="py">datadir</span><span class="p">=</span><span class="s">/data/mysql/data</span>

<span class="c"># 允许最大连接数
</span><span class="py">max_connections</span><span class="p">=</span><span class="s">2000</span>

<span class="c"># 默认数据库字符集
</span><span class="py">character-set-server</span><span class="p">=</span><span class="s">utf8mb4</span>
<span class="py">collation-server</span> <span class="p">=</span> <span class="s">utf8mb4_unicode_ci</span>
<span class="py">init_connect</span> <span class="p">=</span> <span class="s">'SET NAMES utf8mb4'</span>

<span class="c"># 创建新表时将使用的默认存储引擎
</span><span class="py">default-storage-engine</span><span class="p">=</span><span class="s">INNODB</span>

<span class="c"># MYSQL 大小写不敏感
</span><span class="py">lower_case_table_names</span><span class="p">=</span><span class="s">1</span>
<span class="py">max_allowed_packet</span><span class="p">=</span><span class="s">16M</span>
<span class="py">default-authentication-plugin</span><span class="p">=</span><span class="s">caching_sha2_password</span>
<span class="py">innodb_file_per_table</span><span class="p">=</span><span class="s">1</span>

<span class="c"># InnoDB 核心参数
</span><span class="py">innodb_buffer_pool_size</span><span class="p">=</span><span class="s">1G</span>
<span class="py">innodb_buffer_pool_instances</span><span class="p">=</span><span class="s">8</span>
<span class="py">innodb_redo_log_capacity</span><span class="p">=</span><span class="s">2G</span>
<span class="py">innodb_log_buffer_size</span><span class="p">=</span><span class="s">32M</span>

<span class="c"># 日志
</span><span class="py">log_error</span><span class="p">=</span><span class="s">/data/mysql/log/mysql-error.log</span>
<span class="py">slow_query_log</span><span class="p">=</span><span class="s">1</span>
<span class="py">slow_query_log_file</span><span class="p">=</span><span class="s">/data/mysql/log/slow-query.log</span>
<span class="py">long_query_time</span><span class="p">=</span><span class="s">2</span>
<span class="py">log_queries_not_using_indexes</span><span class="p">=</span><span class="s">1</span>
<span class="py">log_throttle_queries_not_using_indexes</span><span class="p">=</span><span class="s">60</span>

<span class="c"># 跳过 DNS 反向解析
</span><span class="py">skip-name-resolve</span><span class="p">=</span><span class="s">1</span>
</code></pre></div></div>

<h5 id="3安装-mysql">3、安装 MySQL</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 初始化 mysqld</span>
/data/mysql/bin/mysqld <span class="nt">--initialize</span> <span class="nt">--user</span><span class="o">=</span>mysql

<span class="c"># 查看临时密码和日志是否有报错</span>
<span class="nb">cat</span> /data/mysql/log/mysql-error.log

<span class="c"># 启动 MySQL</span>
/data/mysql/support-files/mysql.server start

<span class="c"># 登录 MySQL</span>
mysql <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div></div>

<blockquote>
  <p>此处登录 MySQL 可能会报错：mysql: error while loading shared libraries: libtinfo.so.5: cannot open shared object file: No such file or directory</p>

  <p>执行此命令修复：<code class="language-plaintext highlighter-rouge">ln -s /usr/lib64/libtinfo.so.6.1 /usr/lib64/libtinfo.so.5</code></p>
</blockquote>

<pre><code class="language-mysql"># 修改 root 用户密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'mysql1234!';

# 对指定 ip 段开放 root 用户远程连接权限
use mysql;
UPDATE user SET user.Host='192.168.216.%' WHERE user.User='root';
FLUSH PRIVILEGES;

# 查询已有用户
SELECT Host, User FROM mysql.user;

# 删除远程登录用户
DELETE FROM USER WHERE User='root' and Host='%';
</code></pre>

<h5 id="4配置开机自启">4、配置开机自启</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 开放端口</span>
firewall-cmd <span class="nt">--zone</span><span class="o">=</span>public <span class="nt">--permanent</span> <span class="nt">--add-port</span><span class="o">=</span>3306/tcp
firewall-cmd <span class="nt">--reload</span>

<span class="c"># 将 mysql.server 复制到 /etc/init.d 下面</span>
<span class="nb">cp</span> /data/mysql/support-files/mysql.server /etc/init.d/mysqld

<span class="c"># 通过 chkconfig 将 mysql 服务添加到开机启动的列表</span>
chkconfig <span class="nt">--add</span> mysqld

<span class="c"># 重启 mysql</span>
systemctl restart mysqld
</code></pre></div></div>]]></content><author><name>Nine</name></author><category term="MySQL" /><summary type="html"><![CDATA[MySQL 安装与使用]]></summary></entry><entry><title type="html">Centos7 下升级 OpenSSH</title><link href="https://blog.nine.gt.tc/2021/08/18/centos7-upgrade-openssh/" rel="alternate" type="text/html" title="Centos7 下升级 OpenSSH" /><published>2021-08-18T00:00:00+08:00</published><updated>2021-08-18T00:00:00+08:00</updated><id>https://blog.nine.gt.tc/2021/08/18/centos7-upgrade-openssh</id><content type="html" xml:base="https://blog.nine.gt.tc/2021/08/18/centos7-upgrade-openssh/"><![CDATA[<p>Centos7.6 升级后测试 ssh 登录及重启后 ssh 登录均无问题，升级无需卸载原先的 openssl 和 openssh。</p>

<p>系统环境为服务器安装镜像时自带的 openssh，没有经历过手动编译安装方式</p>

<h5 id="1升级准备">1、升级准备</h5>

<p>升级前版本</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210818183950745.png" alt="image-20210818183950745" /></p>

<p>升级后版本</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210818210016091.png" alt="image-20210818210016091" /></p>

<blockquote>
  <p><strong>注意事项：</strong></p>

  <p>升级前先关闭 selinux</p>

  <p>使用 telnet 登录升级，备份 ssh 相关文件，避免失败时无法回退版本</p>

  <p>建议先在相同版本的测试环境进行升级，ssh 服务重启、服务器重启、su 切换用户等无问题后再到生产环境操作</p>
</blockquote>

<p>先使用 yum 升级到目前 yum 仓库默认的 openssh7.4p1 版本，再进行编译安装升级到 openssh8.6p1</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> update openssh
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210818191234569.png" alt="image-20210818191234569" /></p>

<p>关闭 selinux：<code class="language-plaintext highlighter-rouge">vim /etc/selinux/config</code>，将<code class="language-plaintext highlighter-rouge">SELINUX=enforcing</code>改为<code class="language-plaintext highlighter-rouge">SELINUX=disabled</code></p>

<p>重启服务器：<code class="language-plaintext highlighter-rouge">shutdown -r now</code></p>

<h5 id="2安装配置-telnet">2、安装配置 telnet</h5>

<p>防止SSH远程控制时，升级过程中出现连接中断，可通过 telnet 备用方式进行远程连接（由于 telnet 是明文传输，不安全，只作为临时使用，升级完成后，必须停止卸载该服务）</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>xinetd telnet-server
</code></pre></div></div>

<p>修改配置文件：<code class="language-plaintext highlighter-rouge">vim /etc/xinetd.d/telnet</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># default: on</span>
<span class="c"># # description: The telnet server serves telnet sessions; it uses \</span>
<span class="c"># #   unencrypted username/password pairs for authentication.</span>
service telnet
<span class="o">{</span>
     disable     <span class="o">=</span> <span class="nb">yes
     </span>flags       <span class="o">=</span> REUSE
     socket_type <span class="o">=</span> stream               
     <span class="nb">wait</span>        <span class="o">=</span> no
     user        <span class="o">=</span> root
     server      <span class="o">=</span> /usr/sbin/in.telnetd
     log_on_failure  +<span class="o">=</span> USERID
<span class="o">}</span>
</code></pre></div></div>

<p>配置 telnet 登录的终端类型：<code class="language-plaintext highlighter-rouge">vim /etc/securetty</code>，再文件末尾增加一些 pts 终端</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pts/0
pts/1
pts/2
pts/3
</code></pre></div></div>

<p>设为开机自动启动</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>xinetd
systemctl <span class="nb">enable </span>telnet.socket
systemctl start telnet.socket
systemctl start xinetd

<span class="c"># 查看服务是否启动</span>
netstat <span class="nt">-lntp</span>|grep 23
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210819104413583.png" alt="image-20210819104413583" /></p>

<p>测试 telnet 登录</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210819104602717.png" alt="image-20210819104602717" /></p>

<p>以下升级操作均在 telnet 终端下操作，防止 ssh 连接意外中断造成升级失败</p>

<h5 id="3升级-openssl">3、升级 openssl</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装依赖包</span>
yum <span class="nt">-y</span> <span class="nb">install </span>gcc gcc-c++ glibc make autoconf openssl openssl-devel pcre-devel  pam-devel
yum <span class="nt">-y</span> <span class="nb">install </span>pam<span class="k">*</span> zlib<span class="k">*</span>

<span class="c"># 下载解压 openssl 包</span>
wget https://www.openssl.org/source/openssl-1.1.1g.tar.gz
<span class="nb">tar</span> <span class="nt">-zxvf</span> openssl-1.1.1g.tar.gz

<span class="c"># 备份 openssl (存在就备份)</span>
<span class="nb">mv</span> /usr/bin/openssl /usr/bin/openssl_bak
<span class="nb">mv</span> /usr/include/openssl /usr/include/openssl_bak

<span class="c"># 编译安装 openssl</span>
<span class="nb">cd </span>openssl-1.1.1g
./config <span class="nt">--prefix</span><span class="o">=</span>/usr/ <span class="nt">--openssldir</span><span class="o">=</span>/usr/ shared
make <span class="nt">-j2</span> <span class="o">&amp;&amp;</span> make <span class="nt">-j2</span> <span class="nb">install</span>

<span class="c"># 查看最后的命令 make install 是否有报错，0 表示无问题</span>
<span class="nb">echo</span> <span class="nv">$?</span>

<span class="c"># 查看升级后的 openssl 版本</span>
openssl version
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210818192248033.png" alt="image-20210818192248033" /></p>

<h5 id="4升级-openssh">4、升级 openssh</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载解压 openssh 包</span>
wget https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-8.6p1.tar.gz
<span class="nb">tar</span> <span class="nt">-zxvf</span> openssh-8.6p1.tar.gz
<span class="nb">chown</span> <span class="nt">-R</span> root:root openssh-8.6p1

<span class="c"># 备份ssh</span>
<span class="nb">mv</span> /etc/ssh /etc/ssh.bak
<span class="nb">mv</span> /usr/bin/ssh /usr/bin/ssh.bak
<span class="nb">mv</span> /usr/sbin/sshd /usr/sbin/sshd.bak

<span class="c"># 编译安装 openssh</span>
<span class="nb">cd </span>openssh-8.6p1
./configure <span class="nt">--prefix</span><span class="o">=</span>/usr <span class="nt">--sysconfdir</span><span class="o">=</span>/etc/ssh <span class="nt">--with-ssl-dir</span><span class="o">=</span>/usr/local/ssl <span class="nt">--with-md5-passwords</span> <span class="nt">--with-pam</span> <span class="nt">--with-zlib</span> <span class="nt">--with-tcp-wrappers</span> <span class="nt">--without-hardening</span>
make <span class="nt">-j2</span> <span class="o">&amp;&amp;</span> make <span class="nt">-j2</span> <span class="nb">install</span>

<span class="c"># 查看最后的命令 make install 是否有报错</span>
<span class="nb">echo</span> <span class="nv">$?</span>

<span class="c"># 授权</span>
<span class="nb">chmod </span>600 /etc/ssh/ssh_host_rsa_key /etc/ssh/ssh_host_ecdsa_key /etc/ssh/ssh_host_ed25519_key

<span class="c"># 从原先的解压的包中拷贝一些文件到目标位置</span>
<span class="nb">cp</span> <span class="nt">-a</span> contrib/redhat/sshd.init  /etc/init.d/sshd
<span class="nb">cp</span> <span class="nt">-a</span> contrib/redhat/sshd.pam /etc/pam.d/sshd.pam
<span class="nb">chmod </span>u+x /etc/init.d/sshd

<span class="c"># 将原先 systemd 管理的 sshd 文件删除或者移走，否则会影响重启 sshd 服务</span>
<span class="nb">mv</span> /usr/lib/systemd/system/sshd.service /usr/lib/systemd/system/sshd.service.bak

<span class="c"># 修改 ssh 配置</span>
vim /etc/ssh/sshd_config

UseDNS no
UsePAM <span class="nb">yes
</span>PermitRootLogin <span class="nb">yes
</span>PasswordAuthentication <span class="nb">yes</span>

<span class="c"># 设置开机自启</span>
chkconfig <span class="nt">--add</span> sshd
chkconfig sshd on

<span class="c"># 重启 ssh 服务</span>
systemctl daemon-reload
systemctl restart sshd

<span class="c"># 查看 ssh 状态</span>
systemctl status sshd.service

<span class="c"># 查看升级后的 openssh 版本</span>
ssh <span class="nt">-V</span>
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210818210216061.png" alt="image-20210818210216061" /></p>

<p>使用 systemd 方式测试</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netstat <span class="nt">-lntp</span>
systemctl stop sshd
netstat <span class="nt">-lntp</span>
systemctl start sshd
netstat <span class="nt">-lntp</span>
systemctl restart sshd
netstat <span class="nt">-lntp</span>
</code></pre></div></div>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210818195309024.png" alt="image-20210818195309024" /></p>

<p>telnet 测试</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210819091246218.png" alt="image-20210819091246218" /></p>

<p>重启后再次测试均无问题，关闭 telnet</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl disable xinetd.service
systemctl stop xinetd.service
systemctl disable telnet.socket
systemctl stop telnet.socket
netstat <span class="nt">-lntp</span>
</code></pre></div></div>

<h5 id="5版本回退">5、版本回退</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> <span class="nt">-rf</span> /etc/ssh
<span class="nb">mv</span> /etc/ssh.bak /etc/ssh
<span class="nb">mv</span> /usr/bin/ssh.bak /usr/bin/ssh
<span class="nb">mv</span> /usr/sbin/sshd.bak /usr/sbin/sshd
systemctl restart sshd
ssh <span class="nt">-V</span>
</code></pre></div></div>
<p>回退后注意验证 ssh 登录是否正常</p>

<p><img src="https://fastly.jsdelivr.net/gh/FlyNine/cloudimage/linux/image-20210819102454585.png" alt="image-20210819102454585" /></p>]]></content><author><name>Nine</name></author><category term="Linux" /><summary type="html"><![CDATA[Centos7 下的 openssl、openssh 升级]]></summary></entry></feed>